<Window
    x:Class="MarketCountdownApp.MainWindow"
    x:Name="RootWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="clr-namespace:MarketCountdownApp"
    xmlns:settings="clr-namespace:MarketCountdownApp.Properties;assembly=MarketCountdownApp"
    xmlns:prop="clr-namespace:MarketCountdownApp.Properties"
    Title="Market Countdown"
    WindowStyle="None"
    ResizeMode="NoResize"
    Width="600"
    Height="530"
    Background="{DynamicResource WindowBackgroundBrush}"
    AllowsTransparency="True"
    MouseLeftButtonDown="DragBar_MouseLeftButtonDown">

    <Window.DataContext>
        <local:MainWindowViewModel/>
    </Window.DataContext>

    <!-- ================= -->
    <!--  Window.Resources -->
    <!-- ================= -->
    <Window.Resources>
        <!-- Converters & ViewModel -->
        <local:StatusToBrushConverter x:Key="StatusToBrushConverter"/>
        <local:ProgressToArcConverter x:Key="ProgressToArcConverter"/>
        <local:ImpactToBrushConverter x:Key="ImpactToBrushConverter"/>
        <local:MainWindowViewModel      x:Key="ViewModel"/>
        <local:IconSourceConverter x:Key="IconSourceConverter"/>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>

        <Style TargetType="CheckBox">
            <Setter Property="Foreground" Value="{DynamicResource PrimaryTextBrush}"/>
        </Style>
        <!-- ↑↓ insert the new CityIconStyle RIGHT HERE ↓↑ -->
        <Style x:Key="CityIconStyle" TargetType="Image">
            <Setter Property="Source">
                <Setter.Value>
                    <MultiBinding Converter="{StaticResource IconSourceConverter}">
                        <!-- 1st binding: the Tag on this Image -->
                        <Binding Path="Tag" RelativeSource="{RelativeSource Self}" />
                        <!-- 2nd binding: IsDarkMode from your DataContext -->
                        <Binding Path="DataContext.IsDarkMode"
                                 RelativeSource="{RelativeSource AncestorType=Window}" />
                    </MultiBinding>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Group upcoming events by DayOfWeek -->
        <CollectionViewSource x:Key="EventsByDay"
                          Source="{Binding UpcomingEvents}">
            <CollectionViewSource.GroupDescriptions>
                <PropertyGroupDescription PropertyName="Date.DayOfWeek"/>
            </CollectionViewSource.GroupDescriptions>
        </CollectionViewSource>

        <!-- Group header style -->
        <Style x:Key="DayGroupHeader" TargetType="GroupItem">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="GroupItem">
                        <StackPanel>
                            <TextBlock Text="{Binding Name}"
                         FontWeight="Bold"
                         FontSize="14"
                         Margin="0,8,0,4"
                         Foreground="{DynamicResource PrimaryTextBrush}"/>
                            <ItemsPresenter/>
                        </StackPanel>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Currency tag -->
        <Style x:Key="CurrencyTagStyle" TargetType="Border">
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Padding"     Value="4,2"/>
            <Setter Property="Margin"      Value="6,0"/>
            <Setter Property="Background"  Value="LightGray"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding Currency}" Value="USD">
                    <Setter Property="Background" Value="Crimson"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Currency}" Value="CHF">
                    <Setter Property="Background" Value="#F39C12"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Currency}" Value="CAD">
                    <Setter Property="Background" Value="#9B59B6"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Currency}" Value="EUR">
                    <Setter Property="Background" Value="#2ECC71"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Currency}" Value="AUD">
                    <Setter Property="Background" Value="#3498DB"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Currency}" Value="GBP">
                    <Setter Property="Background" Value="#FFD700"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Currency}" Value="CNY">
                    <Setter Property="Background" Value="#20B2AA"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Currency}" Value="NZD">
                    <Setter Property="Background" Value="#FF69B4"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Currency}" Value="JPY">
                    <Setter Property="Background" Value="#95A5A6"/>
                </DataTrigger>
                <!-- etc. for other currencies -->
            </Style.Triggers>
        </Style>

        <!-- Local time style -->
        <Style x:Key="LocalTimeStyle" TargetType="TextBlock">
            <Setter Property="Foreground" Value="Gray"/>
            <Setter Property="FontSize"   Value="11"/>
        </Style>
    </Window.Resources>

    <Border x:Name="MainBorder"
          Background="{DynamicResource PanelBackgroundBrush}"
          CornerRadius="15"
          SnapsToDevicePixels="True">
        <Grid x:Name="RootGrid">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <!-- Icon bar -->
                <RowDefinition Height="240"/>
                <!-- Tiles -->
                <RowDefinition Height="*"/>
                <!-- Up Next -->
                <RowDefinition Height="Auto"/>
                <!-- Date pill -->
            </Grid.RowDefinitions>

            <!-- ICON BAR -->
            <Border x:Name="DragBar"
              Grid.Row="0"
              HorizontalAlignment="Center"
              Background="{DynamicResource CardBackgroundBrush}"
              CornerRadius="16"
              Padding="4"
              Margin="4">
                <StackPanel Orientation="Horizontal">
                    <!-- London -->
                    <Image Style="{StaticResource CityIconStyle}"
                           Tag="London"
                           Width="32" Height="32"
                           Margin="4"
                           Cursor="Hand"
                           MouseLeftButtonUp="OnIconBarClick"/>
                    <Image Style="{StaticResource CityIconStyle}"
                           Tag="New_York"
                           Width="32" Height="32"
                           Margin="4"
                           Cursor="Hand"
                           MouseLeftButtonUp="OnIconBarClick"/>

                    <Image Style="{StaticResource CityIconStyle}"
                           Tag="Sydney"
                           Width="32" Height="32"
                           Margin="4"
                           Cursor="Hand"
                           MouseLeftButtonUp="OnIconBarClick"/>

                    <Image Style="{StaticResource CityIconStyle}"
                           Tag="Tokyo"
                           Width="32" Height="32"
                           Margin="4"
                           Cursor="Hand"
                           MouseLeftButtonUp="OnIconBarClick"/>

                    <!-- Collapse / Expand -->
                    <!-- COLLAPSE -->
                    <!-- COLLAPSE (always the same PNG) -->
                    <Image  
                        x:Name="CollapseIcon"
                        Source="pack://siteoforigin:,,,/Icons/Collapse.png"
                        Width="24" Height="24"
                        Margin="8,0,0,0"
                        Cursor="Hand"
                        Visibility="Collapsed"
                        MouseLeftButtonUp="OnCollapseClick"/>

                    <Image  
                        x:Name="ExpandIcon"
                        Source="pack://siteoforigin:,,,/Icons/Expand.png"
                        Width="24" Height="24"
                        Margin="4"
                        Cursor="Hand"
                        MouseLeftButtonUp="OnExpandClick"/>
                    <!-- 2) little toggle‐button for the “next event” panel -->
                    <ToggleButton x:Name="NextEventToggle"
                                  Width="24" Height="24"
                                  Margin="8,0,4,0"
                                  FontFamily="Segoe MDL2 Assets"
                                  FontSize="16"
                                  Cursor="Hand"
                                  IsChecked="False"
                                  Visibility="{Binding ShowNextEventToggle, Converter={StaticResource BoolToVis}}"
                                  ToolTip="Show next event">
                        <ToggleButton.Style>
                            <Style TargetType="ToggleButton">
                                <!-- default: right‑pointing chevron -->
                                <Setter Property="Content" Value=""/>
                                <!-- U+E823 -->
                                <!-- U+E7CD “ChevronRight” -->
                                <Style.Triggers>
                                    <!-- when checked: down‑pointing chevron -->
                                    <Trigger Property="IsChecked" Value="True">
                                        <Setter Property="Content" Value=""/>
                                        <!-- U+E121 -->
                                        <!-- U+E70D “ChevronDown” -->
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </ToggleButton.Style>
                    </ToggleButton>
                    <!-- 3) the panel that shows NextEvent; sits to the right of the toggle -->
                    <StackPanel x:Name="NextEventPanel"
                                Orientation="Horizontal"
                                VerticalAlignment="Center"
                                Margin="4,0,0,0"
                                Visibility="{Binding IsChecked, ElementName=NextEventToggle, Converter={StaticResource BoolToVis}}">

                        <!-- 1) Currency pill: just reuse your CurrencyTagStyle -->
                        <Border Style="{StaticResource CurrencyTagStyle}"
                                DataContext="{Binding NextEvent}"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center">
                            <TextBlock Text="{Binding Currency}"
                                       FontSize="12"
                                       FontWeight="Bold"
                                       Foreground="{DynamicResource PrimaryTextBrush}"
                                       Margin="4,0"/>
                        </Border>

                        <!-- countdown timer -->
                        <TextBlock Text="{Binding NextEventCountdown}"
                                   FontSize="14"
                                   FontWeight="SemiBold"
                                   Margin="8,0"
                                   VerticalAlignment="Center"
                                   Foreground="{DynamicResource PrimaryTextBrush}"/>

                        <!-- event title in the impact color -->
                        <TextBlock Text="{Binding NextEvent.Title}"
                                   FontSize="13"
                                   FontWeight="Normal"
                                   Margin="8,0,0,0"
                                   VerticalAlignment="Center"
                                   Foreground="{Binding NextEvent.Impact, Converter={StaticResource ImpactToBrushConverter}}"/>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- MARKET TILES -->
            <UniformGrid x:Name="MainContent"
                   Visibility="Collapsed"
                   Grid.Row="1"
                   Rows="2" Columns="2"
                   Margin="8"
                   DataContext="{Binding MarketVM}">
                <!-- London Tile -->
                <Border Background="{DynamicResource CardBackgroundBrush}"
                CornerRadius="12"
                Margin="4">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="60"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="50"/>
                            <ColumnDefinition Width="60"/>
                        </Grid.ColumnDefinitions>

                        <!-- Icon -->
                        <Image Style="{StaticResource CityIconStyle}"
                               Tag="London"
                               Width="75" Height="75"
                               HorizontalAlignment="Center"
                               Margin="10,0,0,0"
                               VerticalAlignment="Center"/>

                        <!-- Labels -->
                        <StackPanel Grid.Column="1"
                        VerticalAlignment="Center">
                            <TextBlock Text="London"
                         FontSize="14"
                         Foreground="{DynamicResource PrimaryTextBrush}"
                         HorizontalAlignment="Center"/>
                            <TextBlock Text="{Binding LondonDisplay}"
                         FontSize="32"
                         FontWeight="Bold"
                         Foreground="{DynamicResource PrimaryTextBrush}"
                         HorizontalAlignment="Center"/>
                        </StackPanel>

                        <TextBlock Grid.Column="2"
                       Text="{Binding LondonLocalTime}"
                       Style="{StaticResource LocalTimeStyle}"
                       HorizontalAlignment="Center"
                       Margin="12,10,8,0"
                       VerticalAlignment="Top"/>

                        <!-- Status dial -->
                        <Grid Grid.Column="3"
                  Width="60" Height="60"
                  Margin="-20,0,0,0"
                  VerticalAlignment="Center">
                            <Ellipse Stroke="LightGray"
                                     StrokeThickness="6"/>
                            <Canvas>
                                <!-- 1) Outer, very soft halo -->
                                <Path
                                    Data="{Binding LondonProgress, Converter={StaticResource ProgressToArcConverter}}"
                                    Stroke="{Binding LondonStatus, Converter={StaticResource StatusToBrushConverter}}"
                                    StrokeThickness="18"
                                    StrokeStartLineCap="Round"
                                    StrokeEndLineCap="Round"
                                    StrokeLineJoin="Round"
                                    Opacity="0.4">
                                    <Path.Effect>
                                        <BlurEffect Radius="20"/>
                                    </Path.Effect>
                                </Path>

                                <!-- 2) Inner, stronger glow -->
                                <Path
                                    Data="{Binding LondonProgress, Converter={StaticResource ProgressToArcConverter}}"
                                    Stroke="{Binding LondonStatus, Converter={StaticResource StatusToBrushConverter}}"
                                    StrokeThickness="14"
                                    StrokeStartLineCap="Round"
                                    StrokeEndLineCap="Round"
                                    StrokeLineJoin="Round"
                                    Opacity="0.7">
                                    <Path.Effect>
                                        <BlurEffect Radius="10"/>
                                    </Path.Effect>
                                </Path>

                                <!-- 3) Crisp foreground ring -->
                                <Path
                                    Data="{Binding LondonProgress, Converter={StaticResource ProgressToArcConverter}}"
                                    Stroke="{Binding LondonStatus, Converter={StaticResource StatusToBrushConverter}}"
                                    StrokeThickness="6"
                                    StrokeStartLineCap="Round"
                                    StrokeEndLineCap="Round"
                                    StrokeLineJoin="Round"/>
                            </Canvas>


                            <TextBlock Text="{Binding LondonStatus}"
                         FontSize="10"
                         FontWeight="Bold"
                         Foreground="{DynamicResource PrimaryTextBrush}"
                         HorizontalAlignment="Center"
                         VerticalAlignment="Center"/>
                        </Grid>
                        <!-- glowing dot -->
                        <Grid Grid.Column="0"
                              Width="20" Height="20"
                              HorizontalAlignment="Left"
                              VerticalAlignment="Top"
                              Margin="6">
                            <Ellipse Width="20" Height="20" Opacity="0.3">
                                <Ellipse.Style>
                                    <Style TargetType="Ellipse">
                                        <Setter Property="Fill" Value="Gray"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding LondonStatus}" Value="OPEN">
                                                <Setter Property="Fill" Value="#40C832"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding LondonStatus}" Value="CLOSED">
                                                <Setter Property="Fill" Value="#EB5757"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                                <Ellipse.Effect>
                                    <BlurEffect Radius="6"/>
                                </Ellipse.Effect>
                            </Ellipse>
                            <Ellipse Width="12" Height="12"
                                     HorizontalAlignment="Center"
                                     VerticalAlignment="Center">
                                <Ellipse.Style>
                                    <Style TargetType="Ellipse">
                                        <Setter Property="Fill" Value="Gray"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding LondonStatus}" Value="OPEN">
                                                <Setter Property="Fill" Value="#40C832"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding LondonStatus}" Value="CLOSED">
                                                <Setter Property="Fill" Value="#EB5757"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                            </Ellipse>
                        </Grid>
                    </Grid>
                </Border>

                <!-- Repeat the above 3 more times for New York, Sydney, Tokyo,
             swapping out the ImageBrush.Source and bindings accordingly -->
                <!-- ... -->
                <Border Background="{DynamicResource CardBackgroundBrush}" CornerRadius="12" Margin="4">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="60"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="50"/>
                            <ColumnDefinition Width="60"/>
                        </Grid.ColumnDefinitions>
                        <Image Style="{StaticResource CityIconStyle}"
                               Tag="New_York"
                               Width="75" Height="75"
                               HorizontalAlignment="Center"
                               Margin="10,0,0,0"
                               VerticalAlignment="Center"/>
                        <StackPanel Grid.Column="1"
                     VerticalAlignment="Center"
                     HorizontalAlignment="Stretch">
                            <!-- City name, centered -->
                            <TextBlock Text="New York"
                        FontSize="14"
                        Foreground="{DynamicResource PrimaryTextBrush}"
                        HorizontalAlignment="Center"/>
                            <!-- Big offset display, bold, larger, centered -->
                            <TextBlock Text="{Binding NewYorkDisplay}"
                        FontSize="32"
                        FontWeight="Bold"
                        Foreground="{DynamicResource PrimaryTextBrush}"
                        HorizontalAlignment="Center"/>
                        </StackPanel>

                        <TextBlock Grid.Column="2"
        Text="{Binding NewYorkLocalTime}"
        Style="{StaticResource LocalTimeStyle}"
        HorizontalAlignment="Center"
        Margin="12,10,8,0"
        VerticalAlignment="Top"/>
                        <Grid Grid.Column="3"
   Width="60" Height="60"
   HorizontalAlignment="Center"
   Margin="-20,0,0,0"
   VerticalAlignment="Center">
                            <Ellipse Stroke="LightGray"
                                     StrokeThickness="6"/>
                            <Canvas>
                                <!-- 1) Outer, very soft halo -->
                                <Path
                                    Data="{Binding LondonProgress, Converter={StaticResource ProgressToArcConverter}}"
                                    Stroke="{Binding LondonStatus, Converter={StaticResource StatusToBrushConverter}}"
                                    StrokeThickness="18"
                                    StrokeStartLineCap="Round"
                                    StrokeEndLineCap="Round"
                                    StrokeLineJoin="Round"
                                    Opacity="0.4">
                                    <Path.Effect>
                                        <BlurEffect Radius="20"/>
                                    </Path.Effect>
                                </Path>

                                <!-- 2) Inner, stronger glow -->
                                <Path
                                    Data="{Binding NewYorkProgress, Converter={StaticResource ProgressToArcConverter}}"
                                    Stroke="{Binding NewYorkStatus, Converter={StaticResource StatusToBrushConverter}}"
                                    StrokeThickness="14"
                                    StrokeStartLineCap="Round"
                                    StrokeEndLineCap="Round"
                                    StrokeLineJoin="Round"
                                    Opacity="0.7">
                                    <Path.Effect>
                                        <BlurEffect Radius="10"/>
                                    </Path.Effect>
                                </Path>

                                <!-- 3) Crisp foreground ring -->
                                <Path
                                    Data="{Binding NewYorkProgress, Converter={StaticResource ProgressToArcConverter}}"
                                    Stroke="{Binding NewYorkStatus, Converter={StaticResource StatusToBrushConverter}}"
                                    StrokeThickness="6"
                                    StrokeStartLineCap="Round"
                                    StrokeEndLineCap="Round"
                                    StrokeLineJoin="Round"/>
                            </Canvas>
                            <TextBlock Text="{Binding NewYorkStatus}"
          FontSize="10"
          FontWeight="Bold"
          Foreground="{DynamicResource PrimaryTextBrush}"
          HorizontalAlignment="Center"
          VerticalAlignment="Center"/>
                        </Grid>
                        <Grid Grid.Column="0"
   Width="20" Height="20"
   HorizontalAlignment="Left"
   VerticalAlignment="Top"
   Margin="6">
                            <Ellipse Width="20" Height="20" Opacity="0.3">
                                <Ellipse.Style>
                                    <Style TargetType="Ellipse">
                                        <Setter Property="Fill" Value="Gray"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding NewYorkStatus}" Value="OPEN">
                                                <Setter Property="Fill" Value="#40C832"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding NewYorkStatus}" Value="CLOSED">
                                                <Setter Property="Fill" Value="#EB5757"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                                <Ellipse.Effect>
                                    <BlurEffect Radius="6"/>
                                </Ellipse.Effect>
                            </Ellipse>
                            <Ellipse Width="12" Height="12"
        HorizontalAlignment="Center"
        VerticalAlignment="Center">
                                <Ellipse.Style>
                                    <Style TargetType="Ellipse">
                                        <Setter Property="Fill" Value="Gray"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding NewYorkStatus}" Value="OPEN">
                                                <Setter Property="Fill" Value="#40C832"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding NewYorkStatus}" Value="CLOSED">
                                                <Setter Property="Fill" Value="#EB5757"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                            </Ellipse>
                        </Grid>
                    </Grid>
                </Border>

                <!-- Sydney -->
                <Border Background="{DynamicResource CardBackgroundBrush}" CornerRadius="12" Margin="4">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="60"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="50"/>
                            <ColumnDefinition Width="60"/>
                        </Grid.ColumnDefinitions>
                        <Image Style="{StaticResource CityIconStyle}"
                        Tag="Sydney"
                        Width="75" Height="75"
                        HorizontalAlignment="Center"
                        Margin="0,0,0,0"
                        VerticalAlignment="Center"/>
                        <StackPanel Grid.Column="1"
                     VerticalAlignment="Center"
                     HorizontalAlignment="Stretch">
                            <!-- City name, centered -->
                            <TextBlock Text="Sydney"
                        FontSize="14"
                        Foreground="{DynamicResource PrimaryTextBrush}"
                        HorizontalAlignment="Center"/>
                            <!-- Big offset display, bold, larger, centered -->
                            <TextBlock Text="{Binding SydneyDisplay}"
                        FontSize="32"
                        FontWeight="Bold"
                        Foreground="{DynamicResource PrimaryTextBrush}"
                        HorizontalAlignment="Center"/>
                        </StackPanel>

                        <TextBlock Grid.Column="2"
        Text="{Binding SydneyLocalTime}"
        Style="{StaticResource LocalTimeStyle}"
        HorizontalAlignment="Center"
        Margin="12,10,8,0"
        VerticalAlignment="Top"/>
                        <Grid Grid.Column="3"
   Width="60" Height="60"
   HorizontalAlignment="Center"
   Margin="-20,0,0,0"
   VerticalAlignment="Center">
                            <Ellipse Stroke="LightGray"
                                     StrokeThickness="6"/>
                            <Canvas>
                                <!-- 1) Outer, very soft halo -->
                                <Path
                                    Data="{Binding LondonProgress, Converter={StaticResource ProgressToArcConverter}}"
                                    Stroke="{Binding LondonStatus, Converter={StaticResource StatusToBrushConverter}}"
                                    StrokeThickness="18"
                                    StrokeStartLineCap="Round"
                                    StrokeEndLineCap="Round"
                                    StrokeLineJoin="Round"
                                    Opacity="0.4">
                                    <Path.Effect>
                                        <BlurEffect Radius="20"/>
                                    </Path.Effect>
                                </Path>

                                <!-- 2) Inner, stronger glow -->
                                <Path
                                    Data="{Binding SydneyProgress, Converter={StaticResource ProgressToArcConverter}}"
                                    Stroke="{Binding SydneyStatus, Converter={StaticResource StatusToBrushConverter}}"
                                    StrokeThickness="14"
                                    StrokeStartLineCap="Round"
                                    StrokeEndLineCap="Round"
                                    StrokeLineJoin="Round"
                                    Opacity="0.7">
                                    <Path.Effect>
                                        <BlurEffect Radius="10"/>
                                    </Path.Effect>
                                </Path>

                                <!-- 3) Crisp foreground ring -->
                                <Path
                                    Data="{Binding SydneyProgress, Converter={StaticResource ProgressToArcConverter}}"
                                    Stroke="{Binding SydneyStatus, Converter={StaticResource StatusToBrushConverter}}"
                                    StrokeThickness="6"
                                    StrokeStartLineCap="Round"
                                    StrokeEndLineCap="Round"
                                    StrokeLineJoin="Round"/>
                            </Canvas>
                            <TextBlock Text="{Binding SydneyStatus}"
          FontSize="10"
          FontWeight="Bold"
          Foreground="{DynamicResource PrimaryTextBrush}"
          HorizontalAlignment="Center"
          VerticalAlignment="Center"/>
                        </Grid>
                        <Grid Grid.Column="0"
   Width="20" Height="20"
   HorizontalAlignment="Left"
   VerticalAlignment="Top"
   Margin="6">
                            <Ellipse Width="20" Height="20" Opacity="0.3">
                                <Ellipse.Style>
                                    <Style TargetType="Ellipse">
                                        <Setter Property="Fill" Value="Gray"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding SydneyStatus}" Value="OPEN">
                                                <Setter Property="Fill" Value="#40C832"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding SydneyStatus}" Value="CLOSED">
                                                <Setter Property="Fill" Value="#EB5757"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                                <Ellipse.Effect>
                                    <BlurEffect Radius="6"/>
                                </Ellipse.Effect>
                            </Ellipse>
                            <Ellipse Width="12" Height="12"
        HorizontalAlignment="Center"
        VerticalAlignment="Center">
                                <Ellipse.Style>
                                    <Style TargetType="Ellipse">
                                        <Setter Property="Fill" Value="Gray"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding SydneyStatus}" Value="OPEN">
                                                <Setter Property="Fill" Value="#40C832"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding SydneyStatus}" Value="CLOSED">
                                                <Setter Property="Fill" Value="#EB5757"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                            </Ellipse>
                        </Grid>
                    </Grid>
                </Border>

                <!-- Tokyo -->
                <Border Background="{DynamicResource CardBackgroundBrush}" CornerRadius="12" Margin="4">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="60"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="50"/>
                            <ColumnDefinition Width="60"/>
                        </Grid.ColumnDefinitions>
                        <Image Style="{StaticResource CityIconStyle}"
                        Tag="Tokyo"
                        Width="75" Height="75"
                        HorizontalAlignment="Center"
                        Margin="10,0,0,0"
                        VerticalAlignment="Center"/>
                        <StackPanel Grid.Column="1"
                     VerticalAlignment="Center"
                     HorizontalAlignment="Stretch">
                            <!-- City name, centered -->
                            <TextBlock Text="Tokyo"
                        FontSize="14"
                        Foreground="{DynamicResource PrimaryTextBrush}"
                        HorizontalAlignment="Center"/>
                            <!-- Big offset display, bold, larger, centered -->
                            <TextBlock Text="{Binding TokyoDisplay}"
                        FontSize="32"
                        FontWeight="Bold"
                        Foreground="{DynamicResource PrimaryTextBrush}"
                        HorizontalAlignment="Center"/>
                        </StackPanel>

                        <TextBlock Grid.Column="2"
        Text="{Binding TokyoLocalTime}"
        Style="{StaticResource LocalTimeStyle}"
        HorizontalAlignment="Center"
        Margin="12,10,8,0"
        VerticalAlignment="Top"/>
                        <Grid Grid.Column="3"
   Width="60" Height="60"
   HorizontalAlignment="Center"
   Margin="-20,0,0,0"
   VerticalAlignment="Center">
                            <Ellipse Stroke="LightGray"
                                     StrokeThickness="6"/>
                            <Canvas>
                                <!-- 1) Outer, very soft halo -->
                                <Path
                                    Data="{Binding TokyoProgress, Converter={StaticResource ProgressToArcConverter}}"
                                    Stroke="{Binding TokyoStatus, Converter={StaticResource StatusToBrushConverter}}"
                                    StrokeThickness="18"
                                    StrokeStartLineCap="Round"
                                    StrokeEndLineCap="Round"
                                    StrokeLineJoin="Round"
                                    Opacity="0.4">
                                    <Path.Effect>
                                        <BlurEffect Radius="20"/>
                                    </Path.Effect>
                                </Path>

                                <!-- 2) Inner, stronger glow -->
                                <Path
                                    Data="{Binding TokyoProgress, Converter={StaticResource ProgressToArcConverter}}"
                                    Stroke="{Binding TokyoStatus, Converter={StaticResource StatusToBrushConverter}}"
                                    StrokeThickness="14"
                                    StrokeStartLineCap="Round"
                                    StrokeEndLineCap="Round"
                                    StrokeLineJoin="Round"
                                    Opacity="0.7">
                                    <Path.Effect>
                                        <BlurEffect Radius="10"/>
                                    </Path.Effect>
                                </Path>

                                <!-- 3) Crisp foreground ring -->
                                <Path
                                    Data="{Binding TokyoProgress, Converter={StaticResource ProgressToArcConverter}}"
                                    Stroke="{Binding TokyoStatus, Converter={StaticResource StatusToBrushConverter}}"
                                    StrokeThickness="6"
                                    StrokeStartLineCap="Round"
                                    StrokeEndLineCap="Round"
                                    StrokeLineJoin="Round"/>
                            </Canvas>
                            <TextBlock Text="{Binding TokyoStatus}"
          FontSize="10"
          FontWeight="Bold"
          Foreground="{DynamicResource PrimaryTextBrush}"
          HorizontalAlignment="Center"
          VerticalAlignment="Center"/>
                        </Grid>
                        <Grid Grid.Column="0"
   Width="20" Height="20"
   HorizontalAlignment="Left"
   VerticalAlignment="Top"
   Margin="6">
                            <Ellipse Width="20" Height="20" Opacity="0.3">
                                <Ellipse.Style>
                                    <Style TargetType="Ellipse">
                                        <Setter Property="Fill" Value="Gray"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding TokyoStatus}" Value="OPEN">
                                                <Setter Property="Fill" Value="#40C832"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding TokyoStatus}" Value="CLOSED">
                                                <Setter Property="Fill" Value="#EB5757"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                                <Ellipse.Effect>
                                    <BlurEffect Radius="6"/>
                                </Ellipse.Effect>
                            </Ellipse>
                            <Ellipse Width="12" Height="12"
        HorizontalAlignment="Center"
        VerticalAlignment="Center">
                                <Ellipse.Style>
                                    <Style TargetType="Ellipse">
                                        <Setter Property="Fill" Value="Gray"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding TokyoStatus}" Value="OPEN">
                                                <Setter Property="Fill" Value="#40C832"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding TokyoStatus}" Value="CLOSED">
                                                <Setter Property="Fill" Value="#EB5757"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                            </Ellipse>
                        </Grid>
                    </Grid>
                </Border>
            </UniformGrid>

            <!-- UP NEXT -->
            <Border x:Name="UpNextContent"
              Grid.Row="2"
              Visibility="Collapsed"
              Background="{DynamicResource CardBackgroundBrush}"
              CornerRadius="12"
              Margin="8"
                Padding="0">
                <Grid Margin="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Header -->
                    <Grid Grid.Row="0" Margin="160,0,160,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition/>
                        </Grid.ColumnDefinitions>
                        <Rectangle Grid.Column="0" Height="1"
                   Fill="{DynamicResource HeaderLineBrush}"
                   VerticalAlignment="Center"
                   Margin="0,0,5,0"/>
                        <TextBlock Grid.Column="1"
                   Text="UP NEXT"
                   FontSize="16"
                   FontWeight="Bold"
                   Foreground="{DynamicResource HeaderTextBrush}"
                   VerticalAlignment="Center"/>
                        <Rectangle Grid.Column="2" Height="1"
                   Fill="{DynamicResource HeaderLineBrush}"
                   VerticalAlignment="Center"
                   Margin="5,0,0,0"/>
                    </Grid>

                    <!-- Aligned, scrollable list -->
                    <!-- Dark‑themed ListView -->
                    <ListView
        x:Name="EventsListView"
        Grid.Row="1"
        ItemsSource="{Binding Source={StaticResource EventsByDay}}"
        Background="{DynamicResource CardBackgroundBrush}"
        BorderThickness="0"
        ScrollViewer.VerticalScrollBarVisibility="Hidden"
        Foreground="{DynamicResource PrimaryTextBrush}">

                        <!-- Show group headers -->
                        <ListView.GroupStyle>
                            <GroupStyle ContainerStyle="{StaticResource DayGroupHeader}"/>
                        </ListView.GroupStyle>
                        <!-- Remove the default padding so our grid fills edge‑to‑edge -->
                        <!-- each item container gets dark background & white text -->
                        <ListView.ItemContainerStyle>
                            <Style TargetType="ListViewItem">
                                <Setter Property="Background" Value="{DynamicResource CardBackgroundBrush}"/>
                                <Setter Property="Foreground" Value="{DynamicResource PrimaryTextBrush}"/>
                                <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
                                <Setter Property="BorderThickness" Value="0,0,0,1"/>
                                <Setter Property="Padding" Value="4,8"/>
                                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="ListViewItem">
                                            <Border Background="{TemplateBinding Background}"
                                            BorderBrush="{TemplateBinding BorderBrush}"
                                            BorderThickness="{TemplateBinding BorderThickness}">
                                                <ContentPresenter/>
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                                <!-- ↓↓↓ Add your triggers here ↓↓↓ -->
                                <Style.Triggers>
                                    <!-- grey‐out entire row when IsPast == true -->
                                    <DataTrigger Binding="{Binding IsPast}" Value="True">
                                        <Setter Property="Opacity" Value="0.4"/>
                                    </DataTrigger>
                                </Style.Triggers>
                                <!-- ↑↑↑ End new triggers ↑↑↑ -->
                            </Style>
                        </ListView.ItemContainerStyle>

                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,4">
                                    <Grid.ColumnDefinitions>
                                        <!-- 1) Time stamp now Auto -->
                                        <ColumnDefinition Width="Auto"/>
                                        <!-- 2) Currency tag -->
                                        <ColumnDefinition Width="60"/>
                                        <!-- 3) Impact icon -->
                                        <ColumnDefinition Width="30"/>
                                        <!-- 4) Title (fills remaining) -->
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- 1) Time, right‑aligned with small right margin -->
                                    <TextBlock Grid.Column="0"
                     Text="{Binding Time}"
                     FontSize="13"
                     Foreground="{DynamicResource PrimaryTextBrush}"
                     VerticalAlignment="Center"
                     HorizontalAlignment="Right"
                     Margin="0,0,8,0"/>

                                    <!-- 2) Currency tag (no extra Margin) -->
                                    <Border Grid.Column="1"
                  Style="{StaticResource CurrencyTagStyle}"
                  
                  HorizontalAlignment="Center"
                  VerticalAlignment="Center">
                                        <TextBlock Text="{Binding Currency}"
                       FontSize="12"
                       FontWeight="Bold"
                       Foreground="{DynamicResource CardBackgroundBrush}"/>
                                    </Border>

                                    <!-- 3) Folder icon, colored by Impact -->
                                    <TextBlock Grid.Column="2"
                     FontFamily="Segoe MDL2 Assets"
                     Text=""
                     FontSize="14"
                     HorizontalAlignment="Center"
                     VerticalAlignment="Center"
                     Foreground="{Binding Impact, Converter={StaticResource ImpactToBrushConverter}}"/>

                                    <!-- 4) Event title -->
                                    <TextBlock Grid.Column="3"
                     Text="{Binding Title}"
                     FontSize="13"
                     Foreground="{DynamicResource PrimaryTextBrush}"
                     VerticalAlignment="Center"
                     Margin="8,0,0,0"
                     TextTrimming="CharacterEllipsis"/>
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </Grid>
            </Border>

            <!-- SETTINGS GEAR -->
            <Image x:Name="SettingsGear"
             Grid.Row="0"
             Source="pack://application:,,,/MarketCountdownApp;component/Icons/Settings.png"
             Width="18" Height="18"
             HorizontalAlignment="Right"
             VerticalAlignment="Bottom"
             Margin="0,0,12,-7"
             Visibility="Collapsed"
             MouseLeftButtonUp="OpenSettings_Click"/>

            <!-- SETTINGS OVERLAY -->
            <!-- ... -->
            <Grid x:Name="SettingsOverlay"
      Visibility="Collapsed"
      Background="#88000000"    
      Grid.RowSpan="4">
                <!-- span all rows -->
                <Border Width="300"
            Height="350"
            Background="{DynamicResource CardBackgroundBrush}"
            CornerRadius="8"
            VerticalAlignment="Center"
            HorizontalAlignment="Center"
            Padding="16"
            TextElement.Foreground="{DynamicResource PrimaryTextBrush}">
                    <StackPanel>
                        <TextBlock Text="Settings"
                                   Foreground="{DynamicResource PrimaryTextBrush}"
                       FontSize="18"
                       FontWeight="Bold"
                       Margin="0,0,0,12"/>
                        <StackPanel Margin="0,0,0,12">
                            <CheckBox x:Name="DarkModeCheck"  Content="Dark Mode"
                          IsChecked="{Binding IsDarkMode, Mode=TwoWay}"/>
                            <CheckBox Content="Show next‑event expander"
                                      IsChecked="{Binding ShowNextEventToggle, Mode=TwoWay}" />
                            <!-- example setting -->
                            <CheckBox Content="Show seconds in clock"
                          IsChecked="{Binding ShowSeconds, Mode=TwoWay}"/>
                            <CheckBox Content="Use 24‑hour format"
                          IsChecked="{Binding Use24Hour, Mode=TwoWay}"
                          Margin="0,8,0,0"/>
                            <!-- add your own toggles/sliders here -->
                            <TextBlock Text="Show Currency Pairs" FontWeight="SemiBold" Margin="0,8,0,4"/>
                            <UniformGrid Columns="2" Margin="0,0,0,12" DataContext="{x:Static prop:Settings.Default}">
                                <CheckBox x:Name="AUDCheck" Content="AUD" IsChecked="{Binding ShowAUD,Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                <CheckBox x:Name="CADCheck" Content="CAD" IsChecked="{Binding ShowCAD,Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                <CheckBox x:Name="CHFCheck" Content="CHF" IsChecked="{Binding ShowCHF,Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                <CheckBox x:Name="CNYCheck" Content="CNY" IsChecked="{Binding ShowCNY,Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                <CheckBox x:Name="EURCheck" Content="EUR" IsChecked="{Binding ShowEUR,Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                <CheckBox x:Name="GBPCheck" Content="GBP" IsChecked="{Binding ShowGBP,Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                <CheckBox x:Name="JPYCheck" Content="JPY" IsChecked="{Binding ShowJPY,Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                <CheckBox x:Name="NZDCheck" Content="NZD" IsChecked="{Binding ShowNZD,Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                <CheckBox x:Name="USDCheck" Content="USD" IsChecked="{Binding ShowUSD,Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                            </UniformGrid>
                            <!-- Impact‑level filter -->
                            <TextBlock Text="Show News Impact" FontWeight="SemiBold" Margin="0,8,0,4"/>
                            <UniformGrid Columns="2" Margin="0,0,0,12">
                                <CheckBox x:Name="HighImpactCheck"   Content="High"    IsChecked="True"/>
                                <CheckBox x:Name="MediumImpactCheck" Content="Medium"  IsChecked="True"/>
                                <CheckBox x:Name="LowImpactCheck"    Content="Low"     IsChecked="True"/>
                                <CheckBox x:Name="HolidayImpactCheck" Content="Holiday" IsChecked="True"/>
                            </UniformGrid>
                        </StackPanel>
                        <Button Content="Close"
                    Width="80"
                    HorizontalAlignment="Right"
                    Click="CloseSettings_Click"/>
                    </StackPanel>
                </Border>
            </Grid>

            <!-- DATE PILL -->
            <Button
                x:Name="DatePillButton"
                Grid.Row="3"
                Click="DatePillButton_Click"
                Background="{DynamicResource CardBackgroundBrush}"
                Padding="6,2"
                Margin="12"
                HorizontalAlignment="Left"
                VerticalAlignment="Center"
                BorderThickness="0">
                <Button.Template>
                    <ControlTemplate TargetType="Button">
                        <Border
                            Background="{TemplateBinding Background}"
                            CornerRadius="8"
                            Padding="{TemplateBinding Padding}">
                            <ContentPresenter
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Button.Template>
                <TextBlock
                    Text="{Binding TodayDate}"
                    FontSize="12"
                    Foreground="{DynamicResource PrimaryTextBrush}"/>
            </Button>
        </Grid>
    </Border>
</Window>
